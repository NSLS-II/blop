name: CI
permissions:
  contents: read

on:
  push:
  pull_request:
  schedule:
    - cron: '00 6 * * *'  # daily at 6AM UTC
  workflow_dispatch:

jobs:
  scheduled-job:
    if: github.event_name == 'schedule'
    uses: ./.github/workflows/_testing.yml

  check:
    uses: ./.github/workflows/_check.yml
  
  build:
    name: Build Jupyter Notebooks and HTML
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Install pixi and activate environment
        uses: prefix-dev/setup-pixi@v0.8.14
        with:
          pixi-version: v0.46.0
          environments: dev
          cache: false
          activate-environment: dev

      - name: Build HTML
        run: make -C docs/ html

      - name: Build jupyterlite
        run: pixi run build_wasm

      - name: Upload executed notebooks as GitHub artifact (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: executed-notebooks
          path: _build/jupyter_execute
          if-no-files-found: error

      - name: Upload HTML as GitHub artifact (for debugging)
        uses: actions/upload-pages-artifact@v3
        with:
          path: _build/html

  lint:
    needs: check
    if: needs.check.outputs.branch-pr == ''
    uses: ./.github/workflows/_pre-commit.yml

  test:
    needs: lint
    if: needs.check.outputs.branch-pr == ''
    uses: ./.github/workflows/_testing.yml

  docs:
    needs: lint
    if: needs.check.outputs.branch-pr == ''
    uses: ./.github/workflows/_docs.yml
  
  pypi:
    if: success() && github.event_name == 'release'
    needs: [lint, test, docs]
    uses: ./.github/workflows/_publish-pypi.yml
    permissions:
      id-token: write
